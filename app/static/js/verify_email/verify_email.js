// Generated by CoffeeScript 1.3.3
(function() {

  $(function() {
    var $account_id, $alert, $code, $formBody, $formInputs, $submitButton, displayError, displaySuccess, focused;
    $formBody = $('.verify-email-form .proj-form-body');
    $formInputs = $formBody.find('> input');
    $alert = $formBody.find('> .alert');
    $account_id = $('#account_id');
    $code = $('#code');
    $submitButton = $formBody.find('.verify-email-button');
    focused = false;
    $formInputs.each(function() {
      if (!focused && this.value === '') {
        this.focus();
        return focused = true;
      }
    });
    $code.keypress(function(event) {
      var code;
      code = event.keyCode ? event.keyCode : event.charCode;
      if (code === 13) {
        return $submitButton.trigger('click');
      }
    });
    $submitButton.click(function(event) {
      var code,
        _this = this;
      event.preventDefault();
      code = $code.val();
      if (code === '') {
        displayError('Missing code field');
        $formInputs.get(0).focus();
        return;
      }
      $submitButton.button('loading');
      $alert.hide();
      return $.ajax({
        type: 'PUT',
        dataType: 'json',
        contentType: 'application/json',
        url: '/api/accounts/' + $account_id.val(),
        data: JSON.stringify({
          action: 'verify_email',
          code: code
        }),
        success: function(json) {
          displaySuccess('Redirecting to sign in...');
          $formBody.children().not('.alert').hide().filter('input').val('');
          return setTimeout((function() {
            return window.location.href = 'http://' + window.location.host + '/signin';
          }), 750);
        },
        error: function(jqXHR) {
          var json;
          json = JSON.parse(jqXHR.responseText);
          displayError(json[_.keys(JSON.parse(jqXHR.responseText))[0]]);
          $submitButton.button('reset');
          return $formInputs.get(0).focus();
        }
      });
    });
    displayError = function(msg) {
      return $alert.removeClass('alert-success').find('span').text(msg).end().addClass('alert-error').show();
    };
    displaySuccess = function(msg) {
      return $alert.removeClass('alert-error').find('span').text(msg).end().addClass('alert-success').show();
    };
    if ($code.val() !== '') {
      return $submitButton.trigger('click');
    }
  });

}).call(this);
